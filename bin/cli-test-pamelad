#!/bin/sh
# cli-test-pamelad
#
# Copyright Â© 2016 Dynamic Object Language Labs Inc.
#
# This software is licensed under the terms of the
# Apache License, Version 2.0 which can be found in
# the file LICENSE at the root of this distribution.
#
# run cli-test with pamlelad

# NOTE this script will exit on the first failure
set -e


# ensure standalone DB
unset ES_SERVER
# ensure not repl? mode
unset PAGER
export SERVER_HOST=localhost
export SERVER_PORT=9100
export PAMELAD="${SERVER_HOST}:${SERVER_PORT}"

start=$(date +%s)

pamelad -v start

pstart=$(date +%s)

echo " "
echo "-- run cli tests with pamelad -- "
if cli-test; then
    clitest=$(date +%s)
    echo " "
    pamelad -v stop
else
    clitest=$(date +%s)
    echo "stopping pamelad, exiting with failure"
    echo " "
    pamelad -v stop
    exit 1
fi

pstop=$(date +%s)

printf "pamelad-start: %3d\n" $(( $pstart - $start ))
printf "cli-test:      %3d\n" $(( $clitest - $pstart ))
printf "pamelad-stop:  %3d\n" $(( $pstop - $clitest ))
printf "TOTAL:         %3d\n" $(( $pstop - $start ))
